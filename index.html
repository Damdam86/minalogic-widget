<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appels Ã  Projets Minalogic</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            min-height: 100vh;
        }
        #root {
            min-height: 100vh;
        }
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-size: 18px;
            color: #666;
        }
    </style>

    <!-- React & ReactDOM depuis CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- React Query v3 (meilleure compatibilitÃ© UMD) -->
    <script src="https://unpkg.com/react-query@3.39.3/dist/react-query.production.min.js"></script>

    <!-- Supabase JS depuis CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>

    <!-- Tailwind CSS depuis CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root">
        <div class="loading">Chargement des appels Ã  projets...</div>
    </div>

    <script>
        // Configuration Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: 'rgb(59 130 246)',
                            foreground: 'rgb(255 255 255)',
                        }
                    }
                }
            }
        };

        // CrÃ©er le client Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://twrkoddafopkjwsggorp.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3cmtvZGRhZm9wa2p3c2dnb3JwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1MTY1MjUsImV4cCI6MjA2MjA5MjUyNX0.YsaNh1z4RDZwfm2L85siqjc5JUH6Qx3rznZ5F7e_BtQ',
            {
                auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
            }
        );

        // Composant Widget React
        const { useState } = React;
        const { QueryClient, QueryClientProvider, useQuery } = window.ReactQuery;

        const queryClient = new QueryClient({
            defaultOptions: {
                queries: {
                    refetchOnWindowFocus: false,
                    retry: 2,
                    staleTime: 30000,
                }
            }
        });

        // Hook pour rÃ©cupÃ©rer les AAP
        function useProjectCalls(page, pageSize) {
            if (!page) page = 0;
            if (!pageSize) pageSize = 20;
            
            return useQuery(['project-calls', page], async function() {
                const result = await supabaseClient
                    .from('project_calls_normalized_mat')
                    .select('*', { count: 'exact' })
                    .eq('status', 'open')
                    .order('closing_date', { ascending: true, nullsFirst: false })
                    .range(page * pageSize, (page + 1) * pageSize - 1);

                if (result.error) throw result.error;
                return { 
                    calls: result.data || [], 
                    total: result.count || 0, 
                    totalPages: Math.ceil((result.count || 0) / pageSize) 
                };
            });
        }

        // Composant principal
        function ProjectCallsWidget() {
            const pageState = useState(0);
            const page = pageState[0];
            const setPage = pageState[1];
            
            const queryResult = useProjectCalls(page, 20);
            const data = queryResult.data;
            const isLoading = queryResult.isLoading;
            const error = queryResult.error;

            if (error) {
                return React.createElement('div', {
                    className: 'p-8 text-center text-red-600'
                }, 'Erreur: ' + error.message);
            }

            if (isLoading) {
                return React.createElement('div', {
                    className: 'p-8 text-center text-gray-600'
                }, 'Chargement...');
            }

            if (!data || !data.calls || data.calls.length === 0) {
                return React.createElement('div', {
                    className: 'p-8 text-center text-gray-600'
                }, 'Aucun appel Ã  projet ouvert');
            }

            return React.createElement('div', {
                className: 'w-full max-w-7xl mx-auto p-6 space-y-6'
            }, [
                // Titre
                React.createElement('div', {
                    key: 'header',
                    className: 'text-center space-y-2 mb-8'
                }, [
                    React.createElement('h1', {
                        key: 'title',
                        className: 'text-4xl font-bold text-gray-900'
                    }, 'Appels Ã  Projets'),
                    React.createElement('p', {
                        key: 'subtitle',
                        className: 'text-lg text-gray-600'
                    }, data.total + ' appels Ã  projets ouverts')
                ]),

                // Liste
                React.createElement('div', {
                    key: 'list',
                    className: 'space-y-6'
                }, data.calls.map(function(call) {
                    var badgeClass = 'px-3 py-1 rounded-full text-sm font-semibold ';
                    var badgeText = '';
                    
                    if (call.call_type === 'european') {
                        badgeClass += 'bg-blue-500 text-white';
                        badgeText = 'ðŸ‡ªðŸ‡º EuropÃ©en';
                    } else if (call.call_type === 'national') {
                        badgeClass += 'bg-green-500 text-white';
                        badgeText = 'ðŸ‡«ðŸ‡· National';
                    } else {
                        badgeClass += 'bg-purple-500 text-white';
                        badgeText = 'ðŸ“ RÃ©gional';
                    }

                    var cardElements = [
                        React.createElement('span', {
                            key: 'badge',
                            className: badgeClass
                        }, badgeText),
                        React.createElement('h2', {
                            key: 'title',
                            className: 'text-2xl font-bold text-gray-900 mt-3'
                        }, call.title)
                    ];

                    if (call.program) {
                        cardElements.push(React.createElement('p', {
                            key: 'program',
                            className: 'text-sm text-gray-600 mt-2'
                        }, call.program));
                    }

                    if (call.short_description) {
                        var desc = call.short_description.substring(0, 300);
                        if (call.short_description.length > 300) desc += '...';
                        cardElements.push(React.createElement('p', {
                            key: 'desc',
                            className: 'mt-4 text-gray-700'
                        }, desc));
                    }

                    if (call.closing_date) {
                        cardElements.push(React.createElement('div', {
                            key: 'date',
                            className: 'mt-4 text-red-600 font-semibold'
                        }, 'ðŸ—“ï¸ ClÃ´ture : ' + new Date(call.closing_date).toLocaleDateString('fr-FR', {
                            day: 'numeric',
                            month: 'long',
                            year: 'numeric'
                        })));
                    }

                    if (call.official_url) {
                        cardElements.push(React.createElement('a', {
                            key: 'link',
                            href: call.official_url,
                            target: '_blank',
                            rel: 'noopener noreferrer',
                            className: 'inline-block mt-4 px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700'
                        }, 'ðŸ“„ Plus d\'infos'));
                    }

                    return React.createElement('div', {
                        key: call.id,
                        className: 'bg-white rounded-lg shadow-md p-6 hover:shadow-xl transition-shadow border border-gray-200'
                    }, cardElements);
                })),

                // Pagination
                data.totalPages > 1 && React.createElement('div', {
                    key: 'pagination',
                    className: 'flex items-center justify-center gap-4 mt-8 pt-6 border-t'
                }, [
                    React.createElement('button', {
                        key: 'prev',
                        onClick: function() { 
                            setPage(function(p) { return Math.max(0, p - 1); }); 
                        },
                        disabled: page === 0,
                        className: page === 0 ? 
                            'px-4 py-2 rounded-lg bg-gray-100 text-gray-400 cursor-not-allowed' :
                            'px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700'
                    }, 'â† PrÃ©cÃ©dent'),
                    React.createElement('span', {
                        key: 'info',
                        className: 'text-sm text-gray-600'
                    }, 'Page ' + (page + 1) + ' / ' + data.totalPages),
                    React.createElement('button', {
                        key: 'next',
                        onClick: function() { 
                            setPage(function(p) { return Math.min(data.totalPages - 1, p + 1); }); 
                        },
                        disabled: page >= data.totalPages - 1,
                        className: page >= data.totalPages - 1 ?
                            'px-4 py-2 rounded-lg bg-gray-100 text-gray-400 cursor-not-allowed' :
                            'px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700'
                    }, 'Suivant â†’')
                ])
            ]);
        }

        // App
        function App() {
            return React.createElement(
                QueryClientProvider,
                { client: queryClient },
                React.createElement(ProjectCallsWidget)
            );
        }

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
